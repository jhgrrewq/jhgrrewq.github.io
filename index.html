<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="爱好电影，更爱女神阿佳妮；爱网球，更爱罗杰费德勒。网易云音乐深度用户">
<meta property="og:type" content="website">
<meta property="og:title" content="jhgrrewq 前端小站">
<meta property="og:url" content="http://jhgrrewq.github.io/index.html">
<meta property="og:site_name" content="jhgrrewq 前端小站">
<meta property="og:description" content="爱好电影，更爱女神阿佳妮；爱网球，更爱罗杰费德勒。网易云音乐深度用户">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="jhgrrewq 前端小站">
<meta name="twitter:description" content="爱好电影，更爱女神阿佳妮；爱网球，更爱罗杰费德勒。网易云音乐深度用户">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'O0AP0FGXSX',
      apiKey: 'ab7c2224e88a925feeea82c8902add9d',
      indexName: 'jhgrrewq',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://jhgrrewq.github.io/"/>





  <title>jhgrrewq 前端小站</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">jhgrrewq 前端小站</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">置我于死地者 必将赐我以后生</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jhgrrewq.github.io/2020/02/28/dll/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jhgrrewq">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/8380737?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jhgrrewq 前端小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/28/dll/" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-28T09:40:28+08:00">
                2020-02-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>dll</p>
<ol>
<li>dllPlugin 生成 require 或 inport 依赖 生成对应 id 映射 json</li>
<li><p>dllReference 根据 json 生成 js</p>
</li>
<li><p>1  dllEntryPlugin 处理 vendor 依赖数组 LibManifestPlugin 生成 json</p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jhgrrewq.github.io/2019/12/30/轮播图组件/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jhgrrewq">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/8380737?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jhgrrewq 前端小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/30/轮播图组件/" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-30T18:06:40+08:00">
                2019-12-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>title: 轮播图组件<br>tag: </p>
<pre><code>- 轮播图
</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jhgrrewq.github.io/2019/12/22/使用verdaccio 搭建npm私服/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jhgrrewq">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/8380737?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jhgrrewq 前端小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/22/使用verdaccio 搭建npm私服/" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-22T14:45:55+08:00">
                2019-12-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="搭建-npm-私服原因"><a href="#搭建-npm-私服原因" class="headerlink" title="搭建 npm 私服原因"></a>搭建 npm 私服原因</h2><ul>
<li>统一管理（公司内部开发的私有包，方便统一管理、开发和使用）</li>
<li>安全性（由于公司内部开发的模块等并不希望公开, 但又希望内部能方便使用）</li>
<li>加速（自建服务器自带常用 package 的缓存，会缓存下载过的包，节省时间）</li>
</ul>
<h2 id="使用verdaccio"><a href="#使用verdaccio" class="headerlink" title="使用verdaccio"></a>使用verdaccio</h2><p>verdaccio 是 sinopia 开源框架的一个fork，由于sinopia 已不再维护，因此采用 verdaccio</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i –g verdaccio</span><br></pre></td></tr></table></figure>
<h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">verdaccio</span><br><span class="line"></span><br><span class="line"> warn --- config file  - /home/admin/.config/verdaccio/config.yaml <span class="comment"># 默认的配置文件</span></span><br><span class="line"> warn --- Verdaccio started</span><br><span class="line"> warn --- Plugin successfully loaded: verdaccio-htpasswd</span><br><span class="line"> warn --- Plugin successfully loaded: verdaccio-audit</span><br><span class="line"> warn --- http address - http://localhost:4873/ - verdaccio/4.4.0 <span class="comment"># 默认端口</span></span><br></pre></td></tr></table></figure>
<p>可以使用 pm2 来管理进程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm i -g pm2</span><br><span class="line">pm2 start verdaccio</span><br><span class="line"><span class="comment"># pm2 ls 查看进程情况</span></span><br></pre></td></tr></table></figure>
<h3 id="腾讯云服务器配置-nginx"><a href="#腾讯云服务器配置-nginx" class="headerlink" title="腾讯云服务器配置 nginx"></a>腾讯云服务器配置 nginx</h3><p>verdaccio 默认是启动在 4873 端口，腾讯云服务器需要配置 nginx 反向代理到该端口，nginx 配置需要在 <code>/etc/nginx/conf.d/</code> 下新建文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name registry.npm.your.server;</span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_pass              http://127.0.0.1:4873/;</span><br><span class="line">    proxy_set_header        Host <span class="variable">$host</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重启 nginx</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -s reload</span><br></pre></td></tr></table></figure>
<h3 id="verdaccio-配置-（-home-admin-config-verdaccio-config-yaml）"><a href="#verdaccio-配置-（-home-admin-config-verdaccio-config-yaml）" class="headerlink" title="verdaccio 配置 （/home/admin/.config/verdaccio/config.yaml）"></a>verdaccio 配置 （/home/admin/.config/verdaccio/config.yaml）</h3><ul>
<li>verdaccio 默认使用的是 npm官方的源，可改成淘宝的源</li>
<li>私有npm 里面不包含的包, 例如要安装一个vue  包, 找不到的话, 会被代理到默认 npm 源仓库去下载, 并且会缓存在 ./storage 文件夹</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://github.com/verdaccio/verdaccio/tree/master/conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># path to a directory with all packages</span></span><br><span class="line"><span class="comment"># 所有包缓存目录</span></span><br><span class="line">storage: ./storage</span><br><span class="line"><span class="comment"># path to a directory with plugins to include</span></span><br><span class="line"><span class="comment"># 插件目录</span></span><br><span class="line">plugins: ./plugins</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启 web 服务,能够通过 web 访问</span></span><br><span class="line">web:</span><br><span class="line">  title: Verdaccio</span><br><span class="line">  <span class="comment"># comment out to disable gravatar support</span></span><br><span class="line">  <span class="comment"># gravatar: false</span></span><br><span class="line">  <span class="comment"># by default packages are ordercer ascendant (asc|desc)</span></span><br><span class="line">  <span class="comment"># sort_packages: asc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证信息</span></span><br><span class="line">auth:</span><br><span class="line">  htpasswd:</span><br><span class="line">    file: ./htpasswd</span><br><span class="line">    <span class="comment"># Maximum amount of users allowed to register, defaults to "+inf".</span></span><br><span class="line">    <span class="comment"># You can set this to -1 to disable registration.</span></span><br><span class="line">    <span class="comment"># max_users: 1000</span></span><br><span class="line"></span><br><span class="line">security:</span><br><span class="line">  api:</span><br><span class="line">    jwt:</span><br><span class="line">      sign:</span><br><span class="line">        expiresIn: 60d</span><br><span class="line">        notBefore: 1</span><br><span class="line">  web:</span><br><span class="line">    sign:</span><br><span class="line">      expiresIn: 7d</span><br><span class="line">      notBefore: 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># a list of other known repositories we can talk to</span></span><br><span class="line"><span class="comment"># 公有仓库配置</span></span><br><span class="line">uplinks:</span><br><span class="line">  npmjs:</span><br><span class="line">  	<span class="comment"># url: https://registry.npmjs.org/</span></span><br><span class="line">    url: https://registry.taobao.org/</span><br><span class="line"></span><br><span class="line">packages:</span><br><span class="line">  <span class="string">'@*/*'</span>:</span><br><span class="line">    <span class="comment"># scoped packages</span></span><br><span class="line">    <span class="comment"># 代理 表示没有的仓库会去 npmjs 里面去找 </span></span><br><span class="line">    access: <span class="variable">$all</span></span><br><span class="line">    publish: <span class="variable">$authenticated</span></span><br><span class="line">    unpublish: <span class="variable">$authenticated</span></span><br><span class="line">    proxy: npmjs</span><br><span class="line"></span><br><span class="line">  <span class="string">'**'</span>:</span><br><span class="line">    <span class="comment"># allow all users (including non-authenticated users) to read and</span></span><br><span class="line">    <span class="comment"># publish all packages</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># you can specify usernames/groupnames (depending on your auth plugin)</span></span><br><span class="line">    <span class="comment"># and three keywords: "$all", "$anonymous", "$authenticated"</span></span><br><span class="line">    access: <span class="variable">$all</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># allow all known users to publish/publish packages</span></span><br><span class="line">    <span class="comment"># (anyone can register by default, remember?)</span></span><br><span class="line">    publish: <span class="variable">$authenticated</span></span><br><span class="line">    unpublish: <span class="variable">$authenticated</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># if package is not available locally, proxy requests to 'npmjs' registry</span></span><br><span class="line">    proxy: npmjs</span><br><span class="line"></span><br><span class="line"><span class="comment"># You can specify HTTP/1.1 server keep alive timeout in seconds for incomming connections.</span></span><br><span class="line"><span class="comment"># A value of 0 makes the http server behave similarly to Node.js versions prior to 8.0.0, which did not have a keep-alive timeout.</span></span><br><span class="line"><span class="comment"># WORKAROUND: Through given configuration you can workaround following issue https://github.com/verdaccio/verdaccio/issues/301. Set to 0 in case 60 is not enought.</span></span><br><span class="line">server:</span><br><span class="line">  keepAliveTimeout: 60</span><br><span class="line"></span><br><span class="line">middlewares:</span><br><span class="line">  audit:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># log settings</span></span><br><span class="line">logs:</span><br><span class="line">  - &#123; <span class="built_in">type</span>: stdout, format: pretty, level: http &#125;</span><br></pre></td></tr></table></figure>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><ul>
<li>切换源</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 使用 nrm 切换源</span><br><span class="line">npm i -g nrm</span><br><span class="line">nrm add jhgrrewq http:<span class="comment">//registry.npm.jhgrrewq.com/</span></span><br><span class="line">nrm use jhgrrewq</span><br></pre></td></tr></table></figure>
<ul>
<li>注册用户（或登录）</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm adduser / npm login</span><br><span class="line"># 输入用户名密码</span><br></pre></td></tr></table></figure>
<ul>
<li>发布</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># npm publish 标准编写包并发布</span><br><span class="line">npm publish</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jhgrrewq.github.io/2019/12/11/react/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jhgrrewq">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/8380737?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jhgrrewq 前端小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/11/react/" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-11T09:33:59+08:00">
                2019-12-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="起步项目"><a href="#起步项目" class="headerlink" title="起步项目"></a>起步项目</h2><ul>
<li>安装官方脚手架 <code>npm install -g create-react-app</code></li>
<li>创建项目 <code>create-react-app react-study</code></li>
<li>启动项目 <code>npm start</code></li>
</ul>
<h2 id="文件结构"><a href="#文件结构" class="headerlink" title="文件结构"></a>文件结构</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">├── README.md              文档</span><br><span class="line">├── public							   静态资源</span><br><span class="line">│   ├── favicon.ico</span><br><span class="line">│   ├── index.html</span><br><span class="line">│   └── manifest.json</span><br><span class="line">└── src									   源码</span><br><span class="line">    ├── App.css</span><br><span class="line">    ├── App.js             根组件</span><br><span class="line">    ├── App.test.js</span><br><span class="line">    ├── index.css          全局样式</span><br><span class="line">    ├── index.js           入口文件</span><br><span class="line">    ├── logo.svg</span><br><span class="line">    └── serviceWorker.js   pwa支持</span><br><span class="line">├── package.json           npm 依赖</span><br></pre></td></tr></table></figure>
<h2 id="CRA-（create-react-app）项目真容"><a href="#CRA-（create-react-app）项目真容" class="headerlink" title="CRA （create-react-app）项目真容"></a>CRA （create-react-app）项目真容</h2><p>使用 <code>npm run eject</code> 弹出项目真容，会多出两个目录</p>
<p>该操作不可逆</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">├── config</span><br><span class="line">	├── env.js                     处理.env环境变量配置文件</span><br><span class="line">	├── paths.js                   提供各种路径</span><br><span class="line">	├── webpack.config.js          webpack配置文件</span><br><span class="line">	└── webpackDevServer.config.js 测试服务器配置文件</span><br><span class="line">└── scripts                      启动、打包和测试脚本 </span><br><span class="line">	├── build.js                   打包脚本</span><br><span class="line">	├── start.js                   启动脚本</span><br><span class="line">	└── test.js                    测试脚本</span><br></pre></td></tr></table></figure>
<h3 id="env-js"><a href="#env-js" class="headerlink" title="env.js"></a>env.js</h3><p>用来处理 env 文件中配置的变量</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// node 运行环境：development production test 等</span></span><br><span class="line"><span class="keyword">const</span> NODE_ENV = process.env.NODE_ENV</span><br><span class="line"></span><br><span class="line"><span class="comment">// 待扫描的文件名数组</span></span><br><span class="line"><span class="keyword">const</span> dotenvFiles = [</span><br><span class="line">  <span class="string">`<span class="subst">$&#123;paths.dotenv&#125;</span>.<span class="subst">$&#123;NODE_ENV&#125;</span>.local`</span>, <span class="comment">// .env.development.local</span></span><br><span class="line">  <span class="string">`<span class="subst">$&#123;paths.dotenv&#125;</span>.<span class="subst">$&#123;NODE_ENV&#125;</span>`</span>,	     <span class="comment">// .env.development</span></span><br><span class="line">  NODE_ENV !== <span class="string">'test'</span> &amp;&amp; <span class="string">`<span class="subst">$&#123;paths.dotenv&#125;</span>.local`</span>, <span class="comment">// .env.local</span></span><br><span class="line">  paths.dotenv, <span class="comment">// .env</span></span><br><span class="line">].filter(<span class="built_in">Boolean</span>); <span class="comment">// 判断文件存在</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 从 .env* 文件中加载文件变量</span></span><br><span class="line">dotenvFiles.forEach(<span class="function"><span class="params">dotenvFile</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (fs.existsSync(dotenvFile)) &#123;</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">'dotenv-expand'</span>)(</span><br><span class="line">      <span class="built_in">require</span>(<span class="string">'dotenv'</span>).config(&#123;</span><br><span class="line">        path: dotenvFile,</span><br><span class="line">      &#125;)</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="webpack-config-js"><a href="#webpack-config-js" class="headerlink" title="webpack.config.js"></a>webpack.config.js</h3><ul>
<li>支持 ts</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Check if TypeScript is setup 启用 ts</span></span><br><span class="line"><span class="keyword">const</span> useTypeScript = fs.existsSync(paths.appTsConfig); <span class="comment">// 配置 tsconfig.json</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// TypeScript type checking ts 相关插件启用</span></span><br><span class="line">plugins: [</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  useTypeScript &amp;&amp;</span><br><span class="line">    <span class="keyword">new</span> ForkTsCheckerWebpackPlugin(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;)</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>支持 sass 和 css 模块化</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// style files regexes</span></span><br><span class="line"><span class="keyword">const</span> cssRegex = <span class="regexp">/\.css$/</span>;</span><br><span class="line"><span class="keyword">const</span> cssModuleRegex = <span class="regexp">/\.module\.css$/</span>; <span class="comment">// css 模块化</span></span><br><span class="line"><span class="keyword">const</span> sassRegex = <span class="regexp">/\.(scss|sass)$/</span>;</span><br><span class="line"><span class="keyword">const</span> sassModuleRegex = <span class="regexp">/\.module\.(scss|sass)$/</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>: &#123;</span><br><span class="line">  rules: &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// "oneOf" will traverse all following loaders until one will</span></span><br><span class="line">      <span class="comment">// match the requirements. When no loader matches it will fall</span></span><br><span class="line">      <span class="comment">// back to the "file" loader at the end of the loader list.</span></span><br><span class="line">      <span class="comment">// 这里由上至下进行匹配，只有一个匹配后面就不匹配</span></span><br><span class="line">      oneOf: [</span><br><span class="line">        &#123;</span><br><span class="line">          test: cssRegex,</span><br><span class="line">          exclude: cssModuleRegex, <span class="comment">// 优先处理 css ，排除模块化 css 文件</span></span><br><span class="line">          use: getStyleLoaders(&#123;</span><br><span class="line">            importLoaders: <span class="number">1</span>,</span><br><span class="line">            sourceMap: isEnvProduction &amp;&amp; shouldUseSourceMap,</span><br><span class="line">          &#125;),</span><br><span class="line">          sideEffects: <span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          test: cssModuleRegex,</span><br><span class="line">          use: getStyleLoaders(&#123;</span><br><span class="line">            importLoaders: <span class="number">1</span>,</span><br><span class="line">            sourceMap: isEnvProduction &amp;&amp; shouldUseSourceMap,</span><br><span class="line">            modules: &#123;</span><br><span class="line">              getLocalIdent: getCSSModuleLocalIdent,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>入口</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">entry: [</span><br><span class="line">      <span class="comment">// Include an alternative client for WebpackDevServer. A client's job is to</span></span><br><span class="line">      <span class="comment">// connect to WebpackDevServer by a socket and get notified about changes.</span></span><br><span class="line">      <span class="comment">// When you save a file, the client will either apply hot updates (in case</span></span><br><span class="line">      <span class="comment">// of CSS changes), or refresh the page (in case of JS changes). When you</span></span><br><span class="line">      <span class="comment">// make a syntax error, this client will display a syntax error overlay.</span></span><br><span class="line">      <span class="comment">// Note: instead of the default WebpackDevServer client, we use a custom one</span></span><br><span class="line">      <span class="comment">// to bring better experience for Create React App users. You can replace</span></span><br><span class="line">      <span class="comment">// the line below with these two lines if you prefer the stock client:</span></span><br><span class="line">      <span class="comment">// require.resolve('webpack-dev-server/client') + '?/',</span></span><br><span class="line">      <span class="comment">// require.resolve('webpack/hot/dev-server'),</span></span><br><span class="line">      isEnvDevelopment &amp;&amp;</span><br><span class="line">        <span class="built_in">require</span>.resolve(<span class="string">'react-dev-utils/webpackHotDevClient'</span>), <span class="comment">// 开发环境 热更新文件</span></span><br><span class="line">     	paths.appIndexJs <span class="comment">// src/index 入口文件</span></span><br><span class="line">    ].filter(<span class="built_in">Boolean</span>),</span><br></pre></td></tr></table></figure>
<h2 id="React-和-ReactDom"><a href="#React-和-ReactDom" class="headerlink" title="React 和 ReactDom"></a>React 和 ReactDom</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> ReactDom <span class="keyword">from</span> <span class="string">'react-dom'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// babel-loader 可转换 jsx -&gt; vdom, 需要使用 React.createElement() 等</span></span><br><span class="line"><span class="comment">// &lt;h1&gt;test&lt;/h1&gt; -&gt; React.createElement('h1', 'test') </span></span><br><span class="line"><span class="keyword">const</span> jsx = &lt;h1&gt;test&lt;/h1&gt;</span><br><span class="line">ReactDOM.render(jsx, <span class="built_in">document</span>.querySelector(<span class="string">'#root'</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>React 负责逻辑控制， 数据 -&gt; vdom</li>
<li>ReactDom 渲染实际 dom，vdom -&gt; dom，如果是移动端，要用别的库渲染</li>
<li>React 可用 jsx 来描述 UI</li>
</ul>
<h2 id="JSX"><a href="#JSX" class="headerlink" title="JSX"></a>JSX</h2><p>jsx 是一种 js 语法扩展，能很好描述 UI</p>
<ul>
<li>使用 表达式 <code>{}</code></li>
<li>表达式可以是 <code>变量</code> 、<code>常量</code> 、<code>函数</code> 、jsx </li>
<li>条件可以通过三元表达式等实现</li>
<li>数组元素可通过 map 等函数实现</li>
<li>class for 等属于保留字，class 用 className 替代， for 用 htmlFor 替代</li>
<li>style 或 class 可以使用 css 模块化</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> style <span class="keyword">from</span> <span class="string">'./index.module.css'</span></span><br><span class="line">&lt;h1 className=&#123; style.img &#125;&gt;test&lt;<span class="regexp">/h1&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="补充知识"><a href="#补充知识" class="headerlink" title="补充知识"></a>补充知识</h2><h3 id="dotenv-从文件加载环境变量"><a href="#dotenv-从文件加载环境变量" class="headerlink" title="dotenv 从文件加载环境变量"></a>dotenv 从文件加载环境变量</h3><p><code>require(&#39;dotenv&#39;).config()</code> 会默认读取项目根目录下的 .env 文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 可传入路径和编码方式</span><br><span class="line">config(&#123;</span><br><span class="line">  path: <span class="string">''</span>,</span><br><span class="line">  Encoding: <span class="string">''</span> </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jhgrrewq.github.io/2019/11/28/docker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jhgrrewq">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/8380737?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jhgrrewq 前端小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/28/docker/" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-28T13:52:00+08:00">
                2019-11-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="环境配置难度"><a href="#环境配置难度" class="headerlink" title="环境配置难度"></a>环境配置难度</h2><p>虚拟机是带环境安装的一种解决方案，可以在一种操作系统里运行另一种才做系统，但仍有一些缺点：</p>
<ul>
<li>资源占用多</li>
<li>冗余步骤多</li>
<li>启动慢</li>
</ul>
<h2 id="linux-容器"><a href="#linux-容器" class="headerlink" title="linux 容器"></a>linux 容器</h2><p>由于虚拟机的这些缺点，linux 发展了另一种虚拟化技术：linux 容器</p>
<p><strong>linux 容器不是模拟一个完整的操作系统，而是对进程进行隔离</strong>。或者说对容器内进程来说，他接触的资源都是虚拟的，从而实现和底层系统的隔离</p>
<ul>
<li>启动快</li>
</ul>
<p>容器内的应用直接就是底层系统的一个进程，而不是虚拟机内部的进程。启动容器相当于启动本机的一个进程，而不是启动一个操作系统</p>
<ul>
<li>资源占用少</li>
</ul>
<p>容器只占用需要的资源，多个容器可共享资源；虚拟机因为是完整的操作系统，不可避免需要占用所有资源并独享资源</p>
<ul>
<li>体积小</li>
</ul>
<p>容器只要包含用的组件即可；虚拟接则是整个操作系统的打包</p>
<ul>
<li>一致运行环境</li>
<li>持续交付和部署</li>
<li>更轻松的迁移</li>
</ul>
<h2 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h2><p><strong>docker 属于 linux 容器的一种封装，提供简单易用的容器接口，是目前最流行的 linux 容器解决方案</strong></p>
<p> docker 将应用程序和该程序的依赖打包在一个文件。运行该文件会生成一个虚拟容器。程序在该虚拟容器里运行，无需担心环境问题</p>
<p>docker 接口相当简单，可以方便创建和使用容器。容器还可以进行版本管理、复制、分享、修改等</p>
<h2 id="docker-使用流程"><a href="#docker-使用流程" class="headerlink" title="docker 使用流程"></a>docker 使用流程</h2><ul>
<li>通常会写一个或多个 Dockerfile 文件，一个文件对应一个容器。根据 Dockerfile 的文件配置可以烧录一个镜像（可理解为类似制作一个 USB启动盘）。当制作完成镜像，可以运行这个镜像，运行成功就变成了容器</li>
<li>对于启动和关联多个容器，可编写 docker-compose.yml</li>
<li>对容器进行编排做更多配置，可使用 Kubernetes 在不间断服务情况下更新容器</li>
</ul>
<h2 id="docker-安装"><a href="#docker-安装" class="headerlink" title="docker 安装"></a>docker 安装</h2><p>docker 有两个版本： 社区版（Community Editon， 缩写CE）和企业版（Enterprise Edition，缩写EE), 一般使用社区版</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 升级 apt</span><br><span class="line">sudo apt-get update</span><br><span class="line"># 添加相关软件包</span><br><span class="line">sudo apt-get install apt-transport-https ca-certificates curl software-properties-common</span><br><span class="line"># 下载软件包的合法性，需要添加软件源的 GPG 密钥</span><br><span class="line">curl -fsSL https:<span class="comment">//mirrors.ustc.edu.cn/docker-ce/linux/ubuntu/gpg | sudo apt-key add -</span></span><br><span class="line"># source.list 中添加 Docker 软件源</span><br><span class="line">sudo add-apt-repository <span class="string">"deb [arch=amd64] https://mirrors.ustc.edu.cn/docker-ce/linux/ubuntu  $(lsb_release -cs)  stable"</span></span><br><span class="line"># 安装 docker CE</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install docker-ce</span><br><span class="line"># 启动 docker CE</span><br><span class="line">sudo groupadd docker</span><br><span class="line">sudo usermod -aG docker $USER</span><br><span class="line">newgrp docker <span class="comment">// 更新用户组</span></span><br><span class="line"># 测试</span><br><span class="line">docker run hello-world</span><br><span class="line"># 使用 -ti 标志可以接管 docker 启动的 shell</span><br><span class="line">docker run -ti ubuntu bash</span><br></pre></td></tr></table></figure>
<h3 id="镜像加速"><a href="#镜像加速" class="headerlink" title="镜像加速"></a>镜像加速</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> # /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"registry-mirrors"</span>: [</span><br><span class="line">    <span class="string">"https://dockerhub.azk8s.cn"</span>,</span><br><span class="line">    <span class="string">"https://reg-mirror.qiniu.com"</span></span><br><span class="line">] &#125;</span><br><span class="line"></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>
<h3 id="手动构建镜像"><a href="#手动构建镜像" class="headerlink" title="手动构建镜像"></a>手动构建镜像</h3><ul>
<li><code>docker image</code> 查看本地已有镜像</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">ubuntu              latest              <span class="number">775349758637</span>        <span class="number">6</span> weeks ago         <span class="number">64.2</span>MB</span><br><span class="line">hello-world         latest              fce289e99eb9        <span class="number">11</span> months ago       <span class="number">1.84</span>kB</span><br></pre></td></tr></table></figure>
<ul>
<li><code>docker pull</code>  下载镜像 (所有镜像可在 hub.docker.com 中找到)</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ docker pull centos</span><br><span class="line">Using <span class="keyword">default</span> tag: latest</span><br><span class="line">latest: Pulling <span class="keyword">from</span> library/centos</span><br><span class="line"><span class="number">729</span>ec3a6ada3: Pull complete </span><br><span class="line">Digest: sha256:f94c1d992c193b3dc09e297ffd54d8a4f1dc946c37cbeceb26d35ce1647f88d9</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> centos:latest</span><br><span class="line">docker.io/library/centos:latest</span><br></pre></td></tr></table></figure>
<ul>
<li><code>docker rmi</code>  删除镜像 (后面可跟名称或者 imageId)</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker rmi centos</span><br><span class="line">Untagged: centos:latest</span><br><span class="line">Untagged: centos@sha256:f94c1d992c193b3dc09e297ffd54d8a4f1dc946c37cbeceb26d35ce1647f88d9</span><br><span class="line">Deleted: sha256:<span class="number">0</span>f3e07c0138fbe05abcb7a9cc7d63d9bd4c980c3f61fea5efa32e7c4217ef4da</span><br><span class="line">Deleted: sha256:<span class="number">9e607</span>bb861a7d58bece26dd2c02874beedd6a097c1b6eca5255d5eb0d2236983</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>docker run</code>  运行一个镜像，产生一个容器</p>
</li>
<li><p><code>docker ps -a</code>  查看所有容器，不加 a 参数会隐藏停止的容器</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">admin@VM<span class="number">-0</span><span class="number">-9</span>-ubuntu:~$ docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED              STATUS                          PORTS               NAMES</span><br><span class="line"><span class="number">0</span>ba76322c986        ubuntu              <span class="string">"/bin/bash"</span>         About a minute ago   Exited (<span class="number">0</span>) About a minute ago                       laughing_shirley</span><br><span class="line"><span class="number">287</span>fe66ab63c        hello-world         <span class="string">"/hello"</span>            <span class="number">19</span> minutes ago       Exited (<span class="number">0</span>) <span class="number">19</span> minutes ago                           affectionate_wu</span><br></pre></td></tr></table></figure>
<ul>
<li><code>docker rm</code>  删除一个停止容器</li>
<li><code>docker stop</code>  停止运行一个容器</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 移除一个运行的容器会发生错误 </span><br><span class="line">docker rmi fce289e99eb9</span><br><span class="line"><span class="built_in">Error</span> response <span class="keyword">from</span> daemon: conflict: unable to <span class="keyword">delete</span> fce289e99eb9 (must be forced) - image is being used by stopped container <span class="number">76650e1</span>cb919</span><br></pre></td></tr></table></figure>
<h3 id="编写-Dockerfile-文件"><a href="#编写-Dockerfile-文件" class="headerlink" title="编写 Dockerfile 文件"></a>编写 Dockerfile 文件</h3><p>Dockerfile 所有指令可以在 Docker Documentation 中找到</p>
<h4 id="通过-Dockerfile-构建镜像"><a href="#通过-Dockerfile-构建镜像" class="headerlink" title="通过 Dockerfile 构建镜像"></a>通过 Dockerfile 构建镜像</h4><ul>
<li><code>docker build</code> 在当前目录下找到 Dockerfile 文件构建</li>
</ul>
<h4 id="FROM-指令"><a href="#FROM-指令" class="headerlink" title="FROM 指令"></a>FROM 指令</h4><p>自定义镜像基本是基于官方的基础镜像进行更改，使用 From 指令表示以何种镜像为基础</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FROM Ubuntu</span><br></pre></td></tr></table></figure>
<h4 id="RUN-命令"><a href="#RUN-命令" class="headerlink" title="RUN 命令"></a>RUN 命令</h4><p>run 命令用来执行一些 shell 命令，如安装依赖等，通常建议把命令尽量写到一行，因为一个指令就是一个镜像层，安装的命令何在一个层是一种最佳实践</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RUN apt-get install -y vim</span><br></pre></td></tr></table></figure>
<h4 id="VOLUME-指令"><a href="#VOLUME-指令" class="headerlink" title="VOLUME 指令"></a>VOLUME 指令</h4><p>将当前目录下所有文件同步到镜像中，默认 docker 容器中数据都是只读，如果要让他可写，并且可以共享给其他容器必须创建 volume</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">VOLUME [<span class="string">'/code'</span>]</span><br><span class="line">WORKDIR /code</span><br><span class="line">RUN node index.js</span><br><span class="line">docker run -v <span class="variable">$PWD</span>/app:/code</span><br></pre></td></tr></table></figure>
<h4 id="COPY-和-ADD"><a href="#COPY-和-ADD" class="headerlink" title="COPY 和 ADD"></a>COPY 和 ADD</h4><p>这两个命令是把文件复制到容器中，相较而言，ADD 读取远程网络文件更加优秀，一般使用 COPY 即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPY . /code</span><br></pre></td></tr></table></figure>
<h4 id="EXPORT"><a href="#EXPORT" class="headerlink" title="EXPORT"></a>EXPORT</h4><p>将本机端口映射到容器内部端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将本机 80 端口映射到容器内部 8080 端口</span></span><br><span class="line">EXPORT 80 8080</span><br></pre></td></tr></table></figure>
<h4 id="WORKDIR"><a href="#WORKDIR" class="headerlink" title="WORKDIR"></a>WORKDIR</h4><p>用于切换目录，类似 cd 命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WORKDIR /code</span><br></pre></td></tr></table></figure>
<h4 id="运行一个-server-实例"><a href="#运行一个-server-实例" class="headerlink" title="运行一个 server 实例"></a>运行一个 server 实例</h4><ul>
<li>创建 Dockerfile (命令可使用小写)</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从 node 镜像的 slim 版本构建， slim 版本是 node 应用最精简容器</span></span><br><span class="line">from node:slim</span><br><span class="line"><span class="comment"># 将当前目录复制到容器 /code 目录下</span></span><br><span class="line">copy . /code</span><br><span class="line"><span class="comment"># 进入 /code 目录</span></span><br><span class="line">workdir /code</span><br><span class="line"><span class="comment"># 暴露容器 80 端口</span></span><br><span class="line">expose 80</span><br><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">run npm install</span><br><span class="line"><span class="comment"># 运行 index.js 文件</span></span><br><span class="line">cmd node index.js</span><br></pre></td></tr></table></figure>
<ul>
<li>创建 index.js</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> server = <span class="built_in">require</span>(<span class="string">'server'</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; get &#125; = server.router</span><br><span class="line">server(&#123; <span class="attr">port</span>: <span class="number">8080</span> &#125;, [</span><br><span class="line">  get(<span class="string">'/'</span>, ctx =&gt; <span class="string">'hello docker'</span>)</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<ul>
<li>安装依赖</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i server -D</span><br></pre></td></tr></table></figure>
<ul>
<li>忽略 node_modules</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 创建 .dockerignore</span><br><span class="line">node_modules</span><br></pre></td></tr></table></figure>
<ul>
<li>构建镜像,   t 参数可指定名字</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build . -t my_server</span><br></pre></td></tr></table></figure>
<ul>
<li>运行镜像，生成容器</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8080:8080 my_server</span><br></pre></td></tr></table></figure>
<h3 id="docker-compose"><a href="#docker-compose" class="headerlink" title="docker compose"></a>docker compose</h3><h4 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install docker-compose</span><br></pre></td></tr></table></figure>
<h4 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h4><ul>
<li>build </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dicker-compose.yml 藐视了多个容器的属性，运行 build 命令会将自定义 Dockerfile build 成镜像再运行</span></span><br><span class="line"><span class="comment"># 若需要的镜像不存在，会通过 pull 从镜像仓库拉去</span></span><br><span class="line">docker-compose build</span><br></pre></td></tr></table></figure>
<ul>
<li>up</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># up 可启动 docker-compose.yml 中所有服务</span></span><br><span class="line"><span class="comment"># -d 可让服务在后台运行</span></span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>
<ul>
<li>logs</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># logs 查看后台启动的服务日志</span></span><br><span class="line">docker-compose logs</span><br></pre></td></tr></table></figure>
<ul>
<li>down</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将所有通过 up 命令创建的容器停止并销毁</span></span><br><span class="line">docker-compose down</span><br></pre></td></tr></table></figure>
<ul>
<li>ps</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看通过 docker-compose 启动的容器的详细信息</span></span><br><span class="line">docker-compose ps</span><br></pre></td></tr></table></figure>
<ul>
<li>stop</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 停止通过 docker-compose up 启动容器</span></span><br><span class="line">docker-compose stop</span><br></pre></td></tr></table></figure>
<ul>
<li>start</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动被 stop 命令停止的容器</span></span><br><span class="line">docker-compose start</span><br></pre></td></tr></table></figure>
<ul>
<li>restart</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重启容器</span></span><br><span class="line">docker-compose restart</span><br></pre></td></tr></table></figure>
<ul>
<li>exec</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在某个容器中执行命令， 默认会接管一个 shell</span></span><br><span class="line">docker-compose <span class="built_in">exec</span> web sh</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jhgrrewq.github.io/2019/11/26/try-finally/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jhgrrewq">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/8380737?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jhgrrewq 前端小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/26/try-finally/" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-26T10:58:26+08:00">
                2019-11-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">  <span class="comment">// 可能抛出异常</span></span><br><span class="line">&#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">	<span class="comment">// 捕获异常</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">  <span class="comment">// 不管有无异常都执行</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>finally 中的代码不管有无异常都会执行：</p>
<ul>
<li>如果没有异常发生，try 内代码执行结束后执行</li>
<li>如果异常发生并且被 catch 捕获，在 catch 代码执行结束后执行</li>
<li>如果有异常发生但没被捕获，在异常被抛给上层之前执行</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ret</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> ret = <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    ret = <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">ret() <span class="comment">// 0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果 try 或 catch 语句内有 return 语句，则 <strong>return 语句在 finally 语句后才执行，但是 finally 不能改变返回值</strong></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ret</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> ret = <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">ret() <span class="comment">// 1</span></span><br></pre></td></tr></table></figure>
<ul>
<li>finally 中有 return 语句，实际会返回 finally 中的返回值，try 和 catch 中的返回值会被覆盖</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ret</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">5</span>/<span class="number">0</span></span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">ret() <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ret</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">5</span>/<span class="number">0</span></span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'test'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">ret() <span class="comment">// Uncaught Error: test</span></span><br></pre></td></tr></table></figure>
<ul>
<li>finally 不仅 return 语句会覆盖异常，如果 finally 抛出异常，则原异常也会覆盖</li>
</ul>
<p>综上，应该<strong>避免在 finally 中使用 return 语句和排除异常</strong>， 如果调用其他代码可能抛出异常，应先捕获异常并进行处理</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jhgrrewq.github.io/2019/11/19/vue3 composition api 简易实现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jhgrrewq">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/8380737?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jhgrrewq 前端小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/19/vue3 composition api 简易实现/" itemprop="url">vue3 composition api 简易实现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-19T09:10:56+08:00">
                2019-11-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>vue3 已经推出<a href="https://github.com/jhgrrewq/vue-next" target="_blank" rel="noopener">Pre-Alpha 版本</a>, 除了 SSR、keep-alive、transition 和v-on/v-model/v-text/v-pre/v-once/v-html/v-show 等指令外，已完成大部分功能。现在我们对 <a href="https://vue-composition-api-rfc.netlify.com/" target="_blank" rel="noopener">vue composition-api</a> 尝鲜，并对其响应式做基本实现</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2019/11/19/vue3 composition api 简易实现/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jhgrrewq.github.io/2019/11/18/es6 reflect/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jhgrrewq">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/8380737?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jhgrrewq 前端小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/18/es6 reflect/" itemprop="url">es6 proxy</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-18T17:22:33+08:00">
                2019-11-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>参考: <a href="http://es6.ruanyifeng.com/#docs/reflect" target="_blank" rel="noopener">ECMAScript 6 入门 reflect 部分</a></p>
</blockquote>
<!-- markdownlint-disable MD010 -->
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Reflect 对象的设计有如下目的：</p>
<ul>
<li>将 Object 对象的一些明显属于语言内部方法放到 Reflect 对象上（如 Object.defineProperty）。目前某些方法同时在 Object 对象和 Reflect 对象上部署，未来的新方法将只在 Reflect 对象上部署</li>
<li>修改某些 Object 方法的返回结果变得合理。如 Object.defineProperty(obj, name, desc) 在无法定义属性时会抛出错误，Reflect.defineProperty(obj, name, desc) 则返回 false</li>
<li>让 Object 操作都变成函数行为。某些 Object 操作是命令式如 name in obj 和 delete obj[name], 而 Reflect.has(obj, name) 和 Reflect.deleteProperty(obj, name) 变成函数行为</li>
<li>Reflect 对象和 Proxy 对象方法一一对应。因此 Proxy 对象可以方便调用对应的 Reflect 方法，完成默认行为，作为修改行为的基础</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不使用 Reflect 对象</span></span><br><span class="line"><span class="keyword">var</span> loggedObj = <span class="keyword">new</span> <span class="built_in">Proxy</span>(obj, &#123;</span><br><span class="line">  get(obj, name) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'get'</span>, obj, name)</span><br><span class="line">    <span class="keyword">return</span> obj[name]</span><br><span class="line">  &#125;,</span><br><span class="line">  deleteProperty(obj, name) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'delete'</span> + name)</span><br><span class="line">    <span class="keyword">delete</span> obj[name]</span><br><span class="line">  &#125;,</span><br><span class="line">  has(obj, name) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'has'</span> + name)</span><br><span class="line">    <span class="keyword">return</span> has(obj, name)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 使用 Reflect 对象，操作更易读</span></span><br><span class="line"><span class="keyword">var</span> loggedObj = <span class="keyword">new</span> <span class="built_in">Proxy</span>(obj, &#123;</span><br><span class="line">  get(obj, name) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'get'</span>, obj, name);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Reflect</span>.get(obj, name);</span><br><span class="line">  &#125;,</span><br><span class="line">  deleteProperty(obj, name) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'delete'</span> + name);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Reflect</span>.deleteProperty(obj, name);</span><br><span class="line">  &#125;,</span><br><span class="line">  has(obj, name) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'has'</span> + name);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Reflect</span>.has(obj, name);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="Reflect-对象静态方法"><a href="#Reflect-对象静态方法" class="headerlink" title="Reflect 对象静态方法"></a>Reflect 对象静态方法</h2><p>Reflect 对象一共有 13 种静态方法：</p>
<ul>
<li><code>Reflect.get(obj, name, receiver)</code>:  <strong>查找并返回 obj 对象的 name 属性，没有则返回 undefined</strong></li>
<li><code>Reflect.set(obj, name, value, receiver)</code>: <strong>设置 obj 对象 name 属性等于 value</strong></li>
<li><code>Reflect.has(obj, name)</code>:  <strong>对应 name in obj 操作</strong> in 运算符</li>
<li>Reflect.deleteProperty(obj, name)` : 等同 <strong>delete obj[name] 操作</strong>, 返回一个布尔值</li>
<li><code>Reflect.ownKeys(obj)</code>: 基本等同 <strong>Object.getOwnPropertyNames(obj) 和 Object.getOwnPropertySymbols(obj) 之和</strong></li>
<li><code>Reflect.getOwnPropertyDescriptor(obj, name)</code>: 基本等同 <strong>Object.getOwnPropertyDescriptor(obj, name)，返回属性的描述对象</strong></li>
<li>Reflect.defineProperty(obj, name, attributes)`: 基本等同 <strong>Object.defineProperty</strong></li>
<li><code>Reflect.preventExtensions(obj)</code>:  对应<strong> Object.preventExtensions(obj), 让一个对象不可扩展，返回一个布尔值，表示是否操作成功</strong></li>
<li><code>Reflect.getPrototypeOf(obj)</code>:  <strong>用于读取对象的 <code>__proto__</code> 属性，对应 Object.getPrototypeOf(proxy)</strong></li>
<li><code>Reflect.isExtensible(obj)</code>: 对应 <strong>Object.isExtensible(obj), 返回一个布尔值, 表示当前对象是否扩展</strong></li>
<li><code>Reflect.setPrototypeOf(obj, proto)</code>:  <strong>用于设置目标对象原型，对应 Object.setPrototypeOf(obj, newProto), 返回一个布尔值表示是否设置成功</strong></li>
<li>Reflect.apply(func, thisArg, args)`: <strong>等同于 Function.prototype.apply.call(obj, args)，用于绑定 this 对象后执行给定函数</strong></li>
<li><code>Reflect.construct(obj, args)</code>：<strong>等同 new obj(…args), 提供一种不适用 new 调用构造函数的方法</strong></li>
</ul>
<h3 id="Reflect-get-obj-name-receiver"><a href="#Reflect-get-obj-name-receiver" class="headerlink" title="Reflect.get(obj, name, receiver)"></a><code>Reflect.get(obj, name, receiver)</code></h3><p><code>Reflect.get</code> 方法查找并返回 obj 对象 name 属性，如果没有该属性返回 undefined</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myObj = &#123;</span><br><span class="line">  foo: <span class="number">1</span>,</span><br><span class="line">  bar: <span class="number">2</span>,</span><br><span class="line">  get baz() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.foo + <span class="keyword">this</span>.bar</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Reflect</span>.get(myObj, <span class="string">'foo'</span>) <span class="comment">// 1</span></span><br><span class="line"><span class="built_in">Reflect</span>.get(myObj, <span class="string">'bar'</span>) <span class="comment">// 2</span></span><br><span class="line"><span class="built_in">Reflect</span>.get(myObj, <span class="string">'baz'</span>) <span class="comment">// 2</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果 name 属性部署了读取函数 getter, 读取函数 this 绑定 receiver</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myObj = &#123;</span><br><span class="line">  foo: <span class="number">1</span>,</span><br><span class="line">  bar: <span class="number">2</span>,</span><br><span class="line">  get baz() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.foo + <span class="keyword">this</span>.bar</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> myReceiveObj = &#123;</span><br><span class="line">	foo: <span class="number">4</span>,</span><br><span class="line">  bar: <span class="number">4</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Reflect</span>.get(myObj, <span class="string">'baz'</span>, myReceiveObj) <span class="comment">// 8</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果第一个参数不是对象，Reflect.get 方法报错</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Reflect</span>.get(<span class="number">1</span>, <span class="string">'foo'</span>) <span class="comment">// 报错</span></span><br></pre></td></tr></table></figure>
<h3 id="Reflect-set-obj-name-value-receiver"><a href="#Reflect-set-obj-name-value-receiver" class="headerlink" title="Reflect.set(obj, name, value, receiver)"></a><code>Reflect.set(obj, name, value, receiver)</code></h3><p><code>Reflect.set</code> 方法设置 obj 对象 name 属性等于 value</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myObj = &#123;</span><br><span class="line">  foo: <span class="number">1</span>,</span><br><span class="line">  set bar(value) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.foo = value</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">myObj.foo <span class="comment">// 1</span></span><br><span class="line"><span class="built_in">Reflect</span>.set(myObj, <span class="string">'foo'</span>, <span class="number">2</span>)</span><br><span class="line">myObj.foo <span class="comment">// 2</span></span><br><span class="line"><span class="built_in">Reflect</span>.set(myObj, <span class="string">'bar'</span>, <span class="number">3</span>)</span><br><span class="line">myObj.foo <span class="comment">// 3</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果第一个参数不是对象, <code>Reflect.set</code> 会报错</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Reflect</span>.set(<span class="number">1</span>, <span class="string">'foo'</span>, &#123;&#125;) <span class="comment">// 报错</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果 name 属性设置了赋值函数，则赋值函数的 this 绑定 receiver</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myObj = &#123;</span><br><span class="line">  foo: <span class="number">2</span>,</span><br><span class="line">  set bar(value) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.foo = value</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> myReceiver = &#123;</span><br><span class="line">  foo: <span class="number">4</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Reflect</span>.set(myObj, <span class="string">'bar'</span>, <span class="number">1</span>, myReceiver)</span><br><span class="line">myObj.foo <span class="comment">// 2</span></span><br><span class="line">myReceiver.foo <span class="comment">// 1</span></span><br></pre></td></tr></table></figure>
<h3 id="Reflect-has-obj-name"><a href="#Reflect-has-obj-name" class="headerlink" title="Reflect.has(obj, name)"></a><code>Reflect.has(obj, name)</code></h3><p><code>Reflect.has</code> 方法对应 name in obj 里面 in 运算符</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myObj = &#123;</span><br><span class="line">  foo: <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 旧写法</span></span><br><span class="line"><span class="string">'foo'</span> <span class="keyword">in</span> myObj <span class="comment">// true</span></span><br><span class="line"><span class="comment">// 新写法</span></span><br><span class="line"><span class="built_in">Reflect</span>.has(myObj, <span class="string">'foo'</span>) <span class="comment">// true</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果 <code>Reflect.has</code> 方法第一个参数不是对象，会报错</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Reflect</span>.has(<span class="number">1</span>, <span class="string">'foo'</span>) <span class="comment">// Reflect.has called on non-object</span></span><br></pre></td></tr></table></figure>
<h3 id="Reflect-deleteProperty-obj-name"><a href="#Reflect-deleteProperty-obj-name" class="headerlink" title="Reflect.deleteProperty(obj, name)"></a><code>Reflect.deleteProperty(obj, name)</code></h3><p><code>Reflect.deleteProperty</code> 方法等同于 delete obj[name], 用于删除对象的属性，返回一个布尔值：如果删除成功，或者被删除属性不存在返回 true; 删除失败，被删除属性依然存在返回 false</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myObj = &#123;</span><br><span class="line">  foo: <span class="string">'bar'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 旧写法</span></span><br><span class="line"><span class="keyword">delete</span> myObj[<span class="string">'foo'</span>]</span><br><span class="line"><span class="comment">// 新写法</span></span><br><span class="line"><span class="built_in">Reflect</span>.deleteProperty(myObj, <span class="string">'foo'</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>如果第一个参数不是对象则报错</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Reflect</span>.deleteProperty(<span class="number">1</span>, <span class="string">'foo'</span>) <span class="comment">// Reflect.deleteProperty called on non-object</span></span><br></pre></td></tr></table></figure>
<h3 id="Reflect-apply-func-thisArg-args"><a href="#Reflect-apply-func-thisArg-args" class="headerlink" title="Reflect.apply(func, thisArg, args)"></a><code>Reflect.apply(func, thisArg, args)</code></h3><p><code>Reflect.apply</code> 方法等同 Function.prototype.apply.call(func, thisArg, args)，用于绑定 this 对象后执行给定函数</p>
<p>一般如果绑定一个函数的 this 对象，可写成 fn.apply(obj, args), 但如果函数定义了自己的 apply 方法，只能写 Function.prototype.apply.call(fn, obj, args), 使用 Reflect 对象能简化操作</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> args = [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line"><span class="comment">// 旧写法</span></span><br><span class="line"><span class="built_in">Object</span>.prototype.toString.call(args)</span><br><span class="line"><span class="built_in">Math</span>.min.call(<span class="built_in">Math</span>, args)</span><br><span class="line"><span class="comment">// 新写法</span></span><br><span class="line"><span class="built_in">Reflect</span>.apply(<span class="built_in">Object</span>.prototype.toString, args, [])</span><br><span class="line"><span class="built_in">Reflect</span>.apply(<span class="built_in">Math</span>.min, <span class="built_in">Math</span>, args)</span><br></pre></td></tr></table></figure>
<h3 id="Reflect-contruct-obj-args"><a href="#Reflect-contruct-obj-args" class="headerlink" title="Reflect.contruct(obj, args)"></a><code>Reflect.contruct(obj, args)</code></h3><p><code>Reflect.contruct</code> 方法等同 new obj(…args), 这提供一种不用 new 来调用构造函数的方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Greeting</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.name = name</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// new 的写法</span></span><br><span class="line"><span class="keyword">const</span> instance = <span class="keyword">new</span> Greeting(<span class="string">'jack'</span>)</span><br><span class="line"><span class="comment">// 新写法</span></span><br><span class="line"><span class="keyword">const</span> instance = <span class="built_in">Reflect</span>.construct(Greeting, [<span class="string">'jack'</span>])</span><br></pre></td></tr></table></figure>
<ul>
<li>如果第一个参数不是函数会报错</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Reflect</span>.construct(&#123;&#125;, <span class="string">'jack'</span>) <span class="comment">// #&lt;Object&gt; is not a constructor</span></span><br></pre></td></tr></table></figure>
<h3 id="Reflect-getPrototypeOf-obj"><a href="#Reflect-getPrototypeOf-obj" class="headerlink" title="Reflect.getPrototypeOf(obj)"></a><code>Reflect.getPrototypeOf(obj)</code></h3><p><code>Reflect.getPrototypeOf</code> 用于读取对象 <code>__proto__</code>, 对应 Object.getPrototypeOf(obj)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myObj = <span class="keyword">new</span> <span class="built_in">Object</span>()</span><br><span class="line"><span class="comment">// 旧写法</span></span><br><span class="line"><span class="built_in">Object</span>.getPrototypeOf(myObj) === <span class="built_in">Object</span>.prototype</span><br><span class="line"><span class="comment">// 新写法</span></span><br><span class="line"><span class="built_in">Reflect</span>.getPrototypeOf(myObj) === <span class="built_in">Object</span>.prototype</span><br></pre></td></tr></table></figure>
<ul>
<li>Reflect.getPrototypeOf 和 Object.getPrototypeOf 的一个区别是，如果参数不是对象，Object.getPrototypeOf 会将这个对象转为对象，再运行，而 Reflect.getPrototypeOf 会报错</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Object</span>.getPrototypeOf(<span class="number">1</span>) <span class="comment">// Number &#123;[[PrimitiveValue]]: 0&#125;</span></span><br><span class="line"><span class="built_in">Reflect</span>.getPrototypeOf(<span class="number">1</span>) <span class="comment">// Reflect.getPrototypeOf called on non-object</span></span><br></pre></td></tr></table></figure>
<h3 id="Relect-setPrototypeOf-obj-newProto"><a href="#Relect-setPrototypeOf-obj-newProto" class="headerlink" title="Relect.setPrototypeOf(obj, newProto)"></a><code>Relect.setPrototypeOf(obj, newProto)</code></h3><p><code>Reflect.setPrototypeOf</code> 方法用于设置目标对象的原型，对应 Object.setPrototypeOf(obj, newProto), 返回一个布尔值表示是否设置成功</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myObj = &#123;&#125;</span><br><span class="line"><span class="comment">// 旧写法</span></span><br><span class="line"><span class="built_in">Object</span>.setPrototypeOf(myObj, <span class="built_in">Array</span>.prototype)</span><br><span class="line"><span class="comment">// 新写法</span></span><br><span class="line"><span class="built_in">Reflect</span>.setPrototytpeOf(myObj, <span class="built_in">Array</span>.prototype)</span><br><span class="line">myObj.length <span class="comment">// 0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果无法设置目标对象原型（如目标对象禁止扩展），Reflect.setPrototypeOf 返回 false</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myObj = &#123;&#125;</span><br><span class="line"><span class="built_in">Object</span>.preventExtensions(myObj) <span class="comment">// Object.freeze(myObj)</span></span><br><span class="line"><span class="built_in">Reflect</span>.setPrototypeOf(myObj, <span class="literal">null</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>如果第一个参数不是对象，Object.setPrototypeOf 返回第一个参数本身，Reflect.setPrototypeOf 报错</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Object</span>.setPrototypeOf(<span class="number">1</span>, &#123;&#125;) <span class="comment">// 1</span></span><br><span class="line"><span class="built_in">Reflect</span>.setPrototypeOf(<span class="number">1</span>, &#123;&#125;) <span class="comment">// Reflect.setPrototypeOf called on non-object</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果第一个参数是 undefined 或 null，Reflect.setPrototypeOf 和 Object.setPrototypeOf 都会报错</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Object</span>.setPrototypeOf(<span class="literal">null</span>, &#123;&#125;) <span class="comment">// Object.setPrototypeOf called on null or undefined</span></span><br><span class="line"><span class="built_in">Reflect</span>.setPrototypeOf(<span class="literal">null</span>, &#123;&#125;) <span class="comment">// Reflect.setPrototypeOf called on non-object</span></span><br></pre></td></tr></table></figure>
<h3 id="Reflect-defineProperty-target-name-attributes"><a href="#Reflect-defineProperty-target-name-attributes" class="headerlink" title="Reflect.defineProperty(target, name, attributes)"></a><code>Reflect.defineProperty(target, name, attributes)</code></h3><p><code>Reflect.defineProperty</code> 方法等同 Object.defineProperty, 用于为对象定义属性</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="comment">// 旧写法</span></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(fn, <span class="string">'foo'</span>, &#123;</span><br><span class="line">  value: <span class="number">1</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 新写法</span></span><br><span class="line"><span class="built_in">Reflect</span>.defineProperty(fn, <span class="string">'foo'</span>, &#123;</span><br><span class="line">  value； <span class="number">1</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>如果第一个参数不是对象会报错</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Reflect</span>.defineProperty(<span class="number">1</span>, <span class="string">'foo'</span>, &#123;</span><br><span class="line">  value: <span class="number">1</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// Reflect.defineProperty called on non-object</span></span><br></pre></td></tr></table></figure>
<ul>
<li>结合 Proxy.defineProperty 配合使用</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> proxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(&#123;&#125;, &#123;</span><br><span class="line">  defineProperty(target, name, attibutes) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Reflect</span>.defineProperty(target, name, attibutes)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line">proxy.foo = <span class="number">1</span></span><br><span class="line">proxy.foo <span class="comment">// 1</span></span><br></pre></td></tr></table></figure>
<h3 id="Reflect-getOwnPropetyDescriptor-target-name"><a href="#Reflect-getOwnPropetyDescriptor-target-name" class="headerlink" title="Reflect.getOwnPropetyDescriptor(target, name)"></a><code>Reflect.getOwnPropetyDescriptor(target, name)</code></h3><p><code></code>Reflect.getOwnPropetyDescriptor` 基本等同 Object.getOwnPropertyDescriptor, 用于得到指定属性的描述对象</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myObj = &#123;&#125;</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(myObj, <span class="string">'hidden'</span>, &#123;</span><br><span class="line">  value: <span class="literal">true</span>,</span><br><span class="line">  enumrable: <span class="literal">true</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 旧写法</span></span><br><span class="line"><span class="built_in">Object</span>.getOwnPropertyDescriptor(myObj, <span class="string">'hidden'</span>)</span><br><span class="line"><span class="comment">// 新写法</span></span><br><span class="line"><span class="built_in">Reflect</span>.getOwnPropertyDescriptor(myObj, <span class="string">'hidden'</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>第一个参数不是对象， Reflect.getOwnPropertyDescriptor 报错， Object.getOwnPropertyDescriptor 会返回 undefined</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Object</span>.getOwnPropertyDescriptor(<span class="number">1</span>, <span class="string">'foo'</span>) <span class="comment">// undefined</span></span><br><span class="line"><span class="built_in">Reflect</span>.getOwnPropertyDescriptor(<span class="number">1</span>, <span class="string">'foo'</span>) <span class="comment">// Reflect.getOwnPropertyDescriptor called on non-object</span></span><br></pre></td></tr></table></figure>
<h3 id="Reflect-isExtensible-target"><a href="#Reflect-isExtensible-target" class="headerlink" title="Reflect.isExtensible(target)"></a><code>Reflect.isExtensible(target)</code></h3><p><code>Reflect.isExtensible</code> 对应 Object.isExtensible, 返回一个布尔值，表示当前对象是否可扩展</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myObj = &#123;&#125;</span><br><span class="line"><span class="comment">// 旧写法</span></span><br><span class="line"><span class="built_in">Object</span>.isExtensible(myObj) <span class="comment">// true</span></span><br><span class="line"><span class="built_in">Reflect</span>.isExtensible(myObj) <span class="comment">// true</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果参数不是对象，Object.isExtensible 返回 false，因为非对象本身不可扩展，Reflect.isExtensible 报错</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Object</span>.isExtensible(<span class="number">1</span>) <span class="comment">// false</span></span><br><span class="line"><span class="built_in">Reflect</span>.isExtensible(<span class="number">1</span>) <span class="comment">// 报错</span></span><br></pre></td></tr></table></figure>
<h3 id="Reflect-preventExtensions-target"><a href="#Reflect-preventExtensions-target" class="headerlink" title="Reflect.preventExtensions(target)"></a><code>Reflect.preventExtensions(target)</code></h3><p><code>Reflect.preventExtensions</code> 对应 Object.preventExtensions 方法，用于让一个对象变为不可扩展，返回一个布尔值，表示是否操作成功</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myObj = &#123;&#125;</span><br><span class="line"><span class="comment">// 旧写法</span></span><br><span class="line"><span class="built_in">Object</span>.preventExtensions(myObj) <span class="comment">// &#123;&#125;</span></span><br><span class="line"><span class="built_in">Reflect</span>.preventExtensions(myObj) <span class="comment">// true</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果参数不是对象，Object.preventExtensions 在 es5 环境报错，es6 环境返回传入参数，Reflect.preventExtensions 报错</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// es5</span></span><br><span class="line"><span class="built_in">Object</span>.preventExtensions(<span class="number">1</span>) <span class="comment">// 报错</span></span><br><span class="line"><span class="comment">// ES6 环境</span></span><br><span class="line"><span class="built_in">Object</span>.preventExtensions(<span class="number">1</span>) <span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 新写法</span></span><br><span class="line"><span class="built_in">Reflect</span>.preventExtensions(<span class="number">1</span>) <span class="comment">// 报错</span></span><br></pre></td></tr></table></figure>
<h3 id="Reflect-ownKeys-target"><a href="#Reflect-ownKeys-target" class="headerlink" title="Reflect.ownKeys(target)"></a><code>Reflect.ownKeys(target)</code></h3><p><code>Reflect.ownKeys</code> 方法返回对象的所有属性，基本等同 Object.getOwnPropertyNames 和 Object.getOwnPropertySymbols 之和</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myObj = &#123;</span><br><span class="line">  foo: <span class="number">1</span>,</span><br><span class="line">  [<span class="built_in">Symbol</span>.for(<span class="string">'bar'</span>)]: <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 旧写法</span></span><br><span class="line"><span class="built_in">Object</span>.getOwnPropertyNames(myObj) <span class="comment">// ['foo']</span></span><br><span class="line"><span class="built_in">Object</span>.getOwnPropertySymbols(myObj) <span class="comment">// [Symbol(baz)]</span></span><br><span class="line"><span class="comment">// 新写法</span></span><br><span class="line"><span class="built_in">Reflect</span>.ownKeys(myObj)</span><br><span class="line"><span class="comment">// ['foo', Symbol(baz)]</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果第一个参数不是对象会报错</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Reflect</span>.ownKeys(<span class="number">1</span>) <span class="comment">// Reflect.ownKeys called on non-object</span></span><br></pre></td></tr></table></figure>
<h2 id="使用-Proxy-实现观察者模式"><a href="#使用-Proxy-实现观察者模式" class="headerlink" title="使用 Proxy 实现观察者模式"></a>使用 Proxy 实现观察者模式</h2><p>这里简易使用函数自动观察数据对象，一旦对象有变化，函数自动执行</p>
<ul>
<li>定义一个 Set 集合，所有观察者函数放入这个集合</li>
<li>函数返回对原始对象的代理，拦击赋值操作</li>
<li>拦截 set 操作中会自动执行所有观察者</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> queuedObservers = <span class="keyword">new</span> <span class="built_in">Set</span>()</span><br><span class="line"><span class="keyword">const</span> observe = <span class="function"><span class="params">fn</span> =&gt;</span> queuedObservers.add(fn)</span><br><span class="line"><span class="keyword">const</span> observable = <span class="function"><span class="params">obj</span> =&gt;</span> <span class="keyword">new</span> <span class="built_in">Proxy</span>(obj, &#123;</span><br><span class="line">  set(target, name, value, receiver) &#123;</span><br><span class="line">		<span class="keyword">const</span> result = <span class="built_in">Reflect</span>.set(target, name, value, receiver)</span><br><span class="line">    queuedObservers.forEach(<span class="function"><span class="params">observer</span> =&gt;</span> observer())</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> person = observable(&#123;</span><br><span class="line">	name: <span class="string">'jack'</span>,</span><br><span class="line">  age: <span class="number">20</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">print</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;person.name&#125;</span>, <span class="subst">$&#123;person.age&#125;</span>`</span>)</span><br><span class="line">&#125;</span><br><span class="line">observe(print)</span><br><span class="line">person.name = <span class="string">'jake'</span> <span class="comment">// jake, 20</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jhgrrewq.github.io/2019/11/18/es6 proxy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jhgrrewq">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/8380737?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jhgrrewq 前端小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/18/es6 proxy/" itemprop="url">es6 proxy</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-18T10:11:41+08:00">
                2019-11-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <blockquote>
<p>参考: <a href="http://es6.ruanyifeng.com/#docs/proxy" target="_blank" rel="noopener">ECMAScript 6 入门 proxy 部分</a></p>
</blockquote>
<!-- markdownlint-disable MD010 -->
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Proxy 用于修改某些操作的默认行为，等同于在语言层变进行修改，属于“元编程”，即对编程语言进行编程</p>
<p>oxy 可理解为在目标对象之前进行一层拦截，外界对该对象的访问，必须先通过这层拦截，因此提供一种机制可以对外界的访问进行过滤和改写</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2019/11/18/es6 proxy/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jhgrrewq.github.io/2019/08/22/jwt/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jhgrrewq">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/8380737?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jhgrrewq 前端小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/22/jwt/" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-22T14:41:03+08:00">
                2019-08-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="跨域认证问题"><a href="#跨域认证问题" class="headerlink" title="跨域认证问题"></a>跨域认证问题</h2><p>互联万服务用户认证一般流程如下</p>
<ul>
<li>用户向服务器发送用户名密码</li>
<li>服务器验证通过后，在当前对话 session 中保存相关数据，如用户角色、登录时间等</li>
<li>服务器向用户返回一个 session_id，写入用户 cookie</li>
<li>用户随后每个请求，都会通过 cookie，将 session_id 传回服务器</li>
<li>服务器收到 session_id，找到前期保存数据</li>
</ul>
<p>这种模式的问题在于扩展性不好，对于服务器集群或是跨域的服务导向架构，要求 session 数据共享。一般有两种解决方法：</p>
<ul>
<li>session 数据持久化，写入数据库或别的持久层</li>
<li>服务器不保存 session 数据，所有数据保存在客户端，每次请求都发回服务器。JWT 方法就是其中代表</li>
</ul>
<h2 id="JWT-原理"><a href="#JWT-原理" class="headerlink" title="JWT 原理"></a>JWT 原理</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"姓名"</span>: <span class="string">"张三"</span>,</span><br><span class="line">  <span class="string">"角色"</span>: <span class="string">"管理员"</span>,</span><br><span class="line">  <span class="string">"到期时间"</span>: <span class="string">"2018年7月1日0点0分"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JWT 原理是服务器认证后生成一个 json 对象 (类似上面这个 json 对象) 发回给用户，之后用户和服务器通信都要发回这个 json 对象。服务器完全只靠这个对象认定用户身份。为防止用户出篡改数据，服务器在生成这个对象时会加上签名</p>
<h2 id="JWT-数据结构"><a href="#JWT-数据结构" class="headerlink" title="JWT 数据结构"></a>JWT 数据结构</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</span><br></pre></td></tr></table></figure>
<p>JWT 是一字符串，中间用点<code>.</code> 分割成了三部分：</p>
<ul>
<li>Header (头部)</li>
<li>Payload (负载)</li>
<li>Signature (签名）</li>
</ul>
<p>写成一行就是 <code>Header.Payload.Signature</code></p>
<h3 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h3><p>Header 部分是一个 json 对象，描述 JWT 的元数据， 一般如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"alg"</span>: <span class="string">"HS256"</span>,</span><br><span class="line">  <span class="string">"typ"</span>: <span class="string">"JWT"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>alg</code> 属性表示签名算法，默认是 HMAC SHA256（写成 HS256）</p>
</li>
<li><p><code>typ</code> 属性表示令牌的类型，JWT 令牌统一为 <code>JWT</code></p>
</li>
</ul>
<p>最终要将上述 json 对象使用 <code>Base64URL</code>算法转成字符串</p>
<h3 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h3><p>Payload 部分也是一个 json 对象，用来存放实际需要传输的数据。JWT 规定了 7 个官方字段供选用</p>
<ul>
<li>iss(issuser)  发送人</li>
<li>exp(expiration time) 过期时间</li>
<li>sub(subject) 主题</li>
<li>aud(audience) 受众</li>
<li>nbf(Not Before) 生效时间</li>
<li>iat(Issued At) 签发时间</li>
<li>jti(JWT ID) 编号</li>
</ul>
<p>除了官方字段，还可以在这部分定义私有字段,  如</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"sub"</span>: <span class="string">"1234567890"</span>,</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"John Doe"</span>,</span><br><span class="line">  <span class="string">"admin"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JWT 默认是不加密的，任何人都可以读取</p>
<p>Payload 部分也要使用 <code>Base64URL</code>算法转成字符串</p>
<h3 id="Signature"><a href="#Signature" class="headerlink" title="Signature"></a>Signature</h3><p>Signature 部分是对前两部分的签名，防止篡改</p>
<p>首先需要指定一个<code>密钥（secret）</code>。 该密钥只能服务器知道，不能泄露给用户。然后使用 Header 指定的签名算法（默认是HMAC SHA256），按照下面公司是产生签名</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HMACSHA256(base64UrlEncode(header)+<span class="string">'.'</span>+base64UrlEncode(payload),</span><br><span class="line">  secret)</span><br></pre></td></tr></table></figure>
<p>算出签名后，把 Header Payload Signature 三部分使用 <code>.</code>  拼接成字符串，返回给用户</p>
<h3 id="base64UrlEncode"><a href="#base64UrlEncode" class="headerlink" title="base64UrlEncode"></a>base64UrlEncode</h3><p>之前提到 Header 和 Payload 串形算法是 base64URL 这个算法类似 base64. 因为 JWT 作为令牌有时候可能会放到 url 中（如 <a href="http://xxx.xx.com/?token=xx）。base64" target="_blank" rel="noopener">http://xxx.xx.com/?token=xx）。base64</a> 中有三个字符 <code>+</code> <code>/</code> <code>=</code></p>
<p>在 url 中有特殊含义，因此要替换掉，<code>=</code> 省略、<code>+</code> 替换成 <code>-</code>、<code>/</code> 体替换成<code>_</code>， 这就是base64URL 算法</p>
<h2 id="JWT-使用方式"><a href="#JWT-使用方式" class="headerlink" title="JWT 使用方式"></a>JWT 使用方式</h2><p>客户端收到服务器发的 JWT，可以存储在 cookie 中，也可以存储在 localStorage 中。此后客户端每次与服务器通信都要带上这个 JWT。可以把它放在 Cookie 里面自动发送，但是这样不能跨域，所以更好的做法是放在 HTTP 请求的头信息<code>Authorization</code>字段里面</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Authorization: Bearer &lt;token&gt;</span><br></pre></td></tr></table></figure>
<h2 id="JWT-特点"><a href="#JWT-特点" class="headerlink" title="JWT 特点"></a>JWT 特点</h2><ul>
<li>JWT 默认是不加密，但也是可以加密的。生成原始 Token 以后，可以用密钥再加密一次</li>
<li>JWT 的最大缺点是，由于服务器不保存 session 状态，因此无法在使用过程中废止某个 token，或者更改 token 的权限。也就是说，一旦 JWT 签发了，在到期之前就会始终有效，除非服务器部署额外的逻辑</li>
<li>JWT 本身包含了认证信息，一旦泄露，任何人都可以获得该令牌的所有权限。为了减少盗用，JWT 的有效期应该设置得比较短。对于一些比较重要的权限，使用时应该再次对用户进行认证</li>
<li>为了减少盗用，JWT 不应该使用 HTTP 协议明码传输，要使用 HTTPS 协议传输</li>
</ul>
<h2 id="jwt-simple-源码"><a href="#jwt-simple-源码" class="headerlink" title="jwt-simple 源码"></a>jwt-simple 源码</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * module dependencies</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * support algorithm mapping</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> algorithmMap = &#123;</span><br><span class="line">  HS256: <span class="string">'sha256'</span>,</span><br><span class="line">  HS384: <span class="string">'sha384'</span>,</span><br><span class="line">  HS512: <span class="string">'sha512'</span>,</span><br><span class="line">  RS256: <span class="string">'RSA-SHA256'</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Map algorithm to hmac or sign type, to determine which crypto function to use</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> typeMap = &#123;</span><br><span class="line">  HS256: <span class="string">'hmac'</span>,</span><br><span class="line">  HS384: <span class="string">'hmac'</span>,</span><br><span class="line">  HS512: <span class="string">'hmac'</span>,</span><br><span class="line">  RS256: <span class="string">'sign'</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * expose object</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> jwt = <span class="built_in">module</span>.exports;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * version</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">jwt.version = <span class="string">'0.5.6'</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Decode jwt</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param &#123;Object&#125; token</span></span><br><span class="line"><span class="comment"> * @param &#123;String&#125; key</span></span><br><span class="line"><span class="comment"> * @param &#123;Boolean&#125; [noVerify]</span></span><br><span class="line"><span class="comment"> * @param &#123;String&#125; [algorithm]</span></span><br><span class="line"><span class="comment"> * @return &#123;Object&#125; payload</span></span><br><span class="line"><span class="comment"> * @api public</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">jwt.decode = <span class="function"><span class="keyword">function</span> <span class="title">jwt_decode</span>(<span class="params">token, key, noVerify, algorithm</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// check token</span></span><br><span class="line">  <span class="keyword">if</span> (!token) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'No token supplied'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// check segments</span></span><br><span class="line">  <span class="keyword">var</span> segments = token.split(<span class="string">'.'</span>);</span><br><span class="line">  <span class="keyword">if</span> (segments.length !== <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Not enough or too many segments'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// All segment should be base64</span></span><br><span class="line">  <span class="keyword">var</span> headerSeg = segments[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">var</span> payloadSeg = segments[<span class="number">1</span>];</span><br><span class="line">  <span class="keyword">var</span> signatureSeg = segments[<span class="number">2</span>];</span><br><span class="line">  <span class="comment">// base64 decode and parse JSON</span></span><br><span class="line">  <span class="keyword">var</span> header = <span class="built_in">JSON</span>.parse(base64urlDecode(headerSeg));</span><br><span class="line">  <span class="keyword">var</span> payload = <span class="built_in">JSON</span>.parse(base64urlDecode(payloadSeg));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!noVerify) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!algorithm &amp;&amp; <span class="regexp">/BEGIN( RSA)? PUBLIC KEY/</span>.test(key.toString())) &#123;</span><br><span class="line">      algorithm = <span class="string">'RS256'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> signingMethod = algorithmMap[algorithm || header.alg];</span><br><span class="line">    <span class="keyword">var</span> signingType = typeMap[algorithm || header.alg];</span><br><span class="line">    <span class="keyword">if</span> (!signingMethod || !signingType) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Algorithm not supported'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// verify signature. `sign` will return base64 string.</span></span><br><span class="line">    <span class="comment">// 将 Header 和 Payload 重新生成签名，和已有的签名比对</span></span><br><span class="line">    <span class="keyword">var</span> signingInput = [headerSeg, payloadSeg].join(<span class="string">'.'</span>);</span><br><span class="line">    <span class="keyword">if</span> (!verify(signingInput, key, signingMethod, signingType, signatureSeg)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Signature verification failed'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Support for nbf and exp claims.</span></span><br><span class="line">    <span class="comment">// According to the RFC, they should be in seconds.</span></span><br><span class="line">    <span class="keyword">if</span> (payload.nbf &amp;&amp; <span class="built_in">Date</span>.now() &lt; payload.nbf*<span class="number">1000</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Token not yet active'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (payload.exp &amp;&amp; <span class="built_in">Date</span>.now() &gt; payload.exp*<span class="number">1000</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Token expired'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> payload;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Encode jwt</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param &#123;Object&#125; payload</span></span><br><span class="line"><span class="comment"> * @param &#123;String&#125; key</span></span><br><span class="line"><span class="comment"> * @param &#123;String&#125; algorithm</span></span><br><span class="line"><span class="comment"> * @param &#123;Object&#125; options</span></span><br><span class="line"><span class="comment"> * @return &#123;String&#125; token</span></span><br><span class="line"><span class="comment"> * @api public</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 一般用法 jwt.encode(payload, secret)</span></span><br><span class="line">jwt.encode = <span class="function"><span class="keyword">function</span> <span class="title">jwt_encode</span>(<span class="params">payload, key, algorithm, options</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 检查 key 密钥</span></span><br><span class="line">  <span class="keyword">if</span> (!key) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Require key'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 检查 algorithm, default is HS256</span></span><br><span class="line">  <span class="keyword">if</span> (!algorithm) &#123;</span><br><span class="line">    algorithm = <span class="string">'HS256'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> signingMethod = algorithmMap[algorithm];</span><br><span class="line">  <span class="keyword">var</span> signingType = typeMap[algorithm];</span><br><span class="line">  <span class="keyword">if</span> (!signingMethod || !signingType) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Algorithm not supported'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// header, typ is fixed value.</span></span><br><span class="line">  <span class="keyword">var</span> header = &#123; <span class="attr">typ</span>: <span class="string">'JWT'</span>, <span class="attr">alg</span>: algorithm &#125;;</span><br><span class="line">  <span class="keyword">if</span> (options &amp;&amp; options.header) &#123;</span><br><span class="line">    assignProperties(header, options.header);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// create segments, all segments should be base64 string</span></span><br><span class="line">  <span class="keyword">var</span> segments = [];</span><br><span class="line">  segments.push(base64urlEncode(<span class="built_in">JSON</span>.stringify(header)));</span><br><span class="line">  segments.push(base64urlEncode(<span class="built_in">JSON</span>.stringify(payload)));</span><br><span class="line">  segments.push(sign(segments.join(<span class="string">'.'</span>), key, signingMethod, signingType));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> segments.join(<span class="string">'.'</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * private util functions</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">assignProperties</span>(<span class="params">dest, source</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> attr <span class="keyword">in</span> source) &#123;</span><br><span class="line">    <span class="keyword">if</span> (source.hasOwnProperty(attr)) &#123;</span><br><span class="line">      dest[attr] = source[attr];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">verify</span>(<span class="params">input, key, method, type, signature</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(type === <span class="string">"hmac"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (signature === sign(input, key, method, type));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span>(type == <span class="string">"sign"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> crypto.createVerify(method)</span><br><span class="line">                 .update(input)</span><br><span class="line">                 .verify(key, base64urlUnescape(signature), <span class="string">'base64'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Algorithm type not recognized'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sign</span>(<span class="params">input, key, method, type</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// HMACSHA256(base64UrlEncode(header)+'.'+base64UrlEncode(payload),secret)</span></span><br><span class="line">  <span class="comment">// sign(input, key)</span></span><br><span class="line">  <span class="keyword">var</span> base64str;</span><br><span class="line">  <span class="keyword">if</span>(type === <span class="string">"hmac"</span>) &#123;</span><br><span class="line">    <span class="comment">// hmc 签名算法</span></span><br><span class="line">    base64str = crypto.createHmac(method, key).update(input).digest(<span class="string">'base64'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span>(type == <span class="string">"sign"</span>) &#123;</span><br><span class="line">    base64str = crypto.createSign(method).update(input).sign(key, <span class="string">'base64'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Algorithm type not recognized'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> base64urlEscape(base64str);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">base64urlDecode</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> Buffer.from(base64urlUnescape(str), <span class="string">'base64'</span>).toString();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">base64urlUnescape</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">  str += <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">5</span> - str.length % <span class="number">4</span>).join(<span class="string">'='</span>);</span><br><span class="line">  <span class="keyword">return</span> str.replace(<span class="regexp">/\-/g</span>, <span class="string">'+'</span>).replace(<span class="regexp">/_/g</span>, <span class="string">'/'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">base64urlEncode</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// str 转为 Buffer 二进制数据，再转为 base64 串</span></span><br><span class="line">  <span class="keyword">return</span> base64urlEscape(Buffer.from(str).toString(<span class="string">'base64'</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">base64urlEscape</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//base64 中有三个字符 + / = 在 url 中有特殊含义，因此要替换掉，= 省略、+ 替换成 -、/ 替换成_， 这就是base64URL 算法</span></span><br><span class="line">  <span class="keyword">return</span> str.replace(<span class="regexp">/\+/g</span>, <span class="string">'-'</span>).replace(<span class="regexp">/\//g</span>, <span class="string">'_'</span>).replace(<span class="regexp">/=/g</span>, <span class="string">''</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Node-crypto-模块"><a href="#Node-crypto-模块" class="headerlink" title="Node crypto 模块"></a>Node crypto 模块</h3><p>HMAC 散列运算消息认证码：</p>
<ul>
<li>运算使用散列算法，以一个密钥 (secret)和一个消息为输入，生成一个消息摘要作为输出</li>
<li>HMAC运算可以用来验证两段数据是否匹配，以确认该数据没有被篡改</li>
</ul>
<p>在使用 HMAC 算法前，使用 createHmac 方法创建一个 hmac 对象</p>
<h4 id="crypto-createHmac-params-key"><a href="#crypto-createHmac-params-key" class="headerlink" title="crypto.createHmac(params, key)"></a><strong>crypto.createHmac(params, key)</strong></h4><p>该方法中使用两个参数，第一个参数含义是在Node.js中使用的<strong>算法</strong>，比如’sha1’, ‘md5’, ‘sha256’, ‘sha512’等等，该方法返回的是<strong>hmac对象</strong>。第二个参数 key 参数值为一个字符串，用于指定一个PEM格式的<strong>密钥</strong>。</p>
<h4 id="hmac-update-data"><a href="#hmac-update-data" class="headerlink" title="hmac.update(data)"></a><strong>hmac.update(data)</strong></h4><p>在该方法中，使用一个参数，其参数值为一个<strong>Buffer对象或一个字符串</strong>，用于<strong>指定摘要内容</strong>。也是一样可以在被输出之前使用多次update方法来添加摘要内容。</p>
<p><strong>最后一步就是使用 hmac 对象的 digest 方法来输出摘要内容了；使用了digest方法作为输出后，因此是不能向hmac对象中追加内容</strong></p>
<p>####<strong>hmac.digest([encoding])</strong></p>
<p>该方法有一个参数，该参数是一个可选值，表示的意思是 用于<strong>指定输出摘要的编码格式</strong>，可指定参数值为 ‘hex’, ‘binary’, 及 ‘base64’. 如果不使用该参数，那么digest方法返回一个是<strong>Buffer对象</strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://avatars0.githubusercontent.com/u/8380737?s=460&v=4"
                alt="jhgrrewq" />
            
              <p class="site-author-name" itemprop="name">jhgrrewq</p>
              <p class="site-description motion-element" itemprop="description">爱好电影，更爱女神阿佳妮；爱网球，更爱罗杰费德勒。网易云音乐深度用户</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">117</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">81</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/jhgrrewq" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">jhgrrewq</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




<div>备案号 <a class="theme-link" target="_blank" href="http://www.beian.miit.gov.cn">浙ICP备18011306号-1</a></div>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.4"></script>



  

  

  

  
  

  

  

  


</body>
</html>
