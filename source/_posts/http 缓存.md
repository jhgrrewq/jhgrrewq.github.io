---
title: http 缓存
tag: 
	- http
---

> 参考: [你应该知道的浏览器缓存知识](https://excaliburhan.com/post/things-you-should-know-about-browser-cache.html)

## http 头信息缓存分类

http 头信息缓存主要有两种：强缓存和协商缓存。强缓存如果命中不需要和服务器发生交互，协商缓存不管是否命中都要和服务器发生交互，强缓存的优先级高于协商缓存

<!-- more -->

![](http://ony85apla.bkt.clouddn.com/18-6-26/19646784.jpg)

匹配流程如下：

- 浏览器发送请求前，根据请求头 `Expires` 和 `Cache-Control` 判断是否命中强缓存策略，如果命中，直接从缓存中获取资源，并不会发送请求，如果没有命中则进入下一步
- 如果没有命中强缓存规则，浏览器会发送请求，根据响应头的 `Last-Modified` 和 `Etag` 判断是否命中协商缓存，如果命中，直接从缓存获取资源，如果命中，直接从服务端获取资源

## 强缓存

### Expires

http 1.0 中的 `Expires` 是服务端返回的数据到期时间，是一个绝对时间， 超过这个时间点就代表资源过期。由于服务器端时间和客户端时间可能有误差，将导致缓存命中的误差，现在大多用 `Cache-Control` 代替。两者同时存在也是 `Cache-Control` 优先级更高

### Cache-Control

http 1.1 中的 `Cache-Control` 选项(**逗号分隔字符串**)

- `public` 表明响应可以被任何对象（包括发送请求的客户端、代理服务器等）缓存
- `private` 只有用户自己的浏览器能缓存
- `no-cache` 强制浏览器在是用 cache 前 **提交一个 http 请求到服务器进行确认。类似协商缓存**
- `no-store` **所有内容都不缓存**
- `max-age=t` **缓存内容在 t 秒后失效**（如果设置 `Expires`, `max-age` 会覆盖 `Expires`）

### 200 from memory cache && 200 from disk cache

命中强缓存**不会发起请求**，但是会有两种状态 `200（from memory cache)` `200(from disk cache)`

- `200（from memory cache)` 将资源存到内存中，从内存中读取
- `200(from disk cache)` 将资源存在磁盘上，从磁盘上获取

命中强缓存的情况下，进程初次渲染会从磁盘读取缓存资源，然后浏览器如 chrome 会将部分资源保存到内存中

### 强缓存作用

强缓存是性能优化中缓存方面最有效的手段，由于强缓存不会向服务端发起请求，能极大缓解服务器压力

对于不太经常变更的资源，可以设置较长时间的缓存时间。资源更新的常用解决方法是给文件添加类似 `？v=xx` 的后缀，在更新静态资源版本时更新这个 v 值，相当于向服务器重新发起一个新请求；或者使用 webpack 等打包工具生成 `[name].[chunkhash].js` 类似的文件名

## 协商缓存

在强缓存没有命中，浏览器会发起请求，协商缓存根据 `Last-Modified/If-Modified-Since` 或者 `Etag/If-None-Match` 来判断缓存是否过期

### Last-Modified/If-Modified-Since

浏览器先发一个请求，让服务端在响应头中返回请求资源的上次更新时间 `Last-Modified`, 浏览器会缓存这个时间。当浏览器下次请求，请求头会在 `If-Moified-Since` 中带上这个时间。根据浏览器发送的修改时间和服务器的修改时间进行对比，**一致的话表示资源没有改变，服务器返回状态码为 `304` 响应体为空的响应，让浏览器从缓存中读取资源；如果修改过就返回最新资源，状态码是 200**

`Last-Modified` 保存的是绝对时间，会出现偏差：

- 保存的时间单位为秒，1 秒内的多次修改无法捕捉
- 各机器读取的时间不一致有出现误差的可能性
- 一些文件也许内容并没有改变（仅仅改变的是修改时间），这是我们不希望文件重新加载

### Etag/If-None-Match

Etag 是一个文件的唯一标识符，只要文件发生变化，Etag 就会变化，生成 Etag 的常用方法包括对资源文件使用抗碰撞散列函数、使用最近修改的时间戳的哈希值、甚至是一个版本号

同样浏览器会发送请求得到一个 `Etag` 值，然后下一次请求, 请求头的 `If-None-Match` 中会带上该 etag 值，通过发送的 etag 值和服务器端**重新生成的 etag 值**进行对比，**一致的话表示资源没有改变，服务器返回状态码为 `304` 响应体为空的响应，让浏览器从缓存中读取资源；如果修改过就返回最新资源，状态码是 200**

## 用户操作行为和缓存

F5 刷新导致强缓存失效

Ctrl + F5 强制刷新导致强缓存失效，协商缓存失效

|用户操作|Epires/Cache-Control|Last-Modified/Etag|
|--|--|--|
|地址栏回车|有效|有效|
|页面链接跳转|有效|有效|
|新开窗口|有效|有效|
|前进后退|有效|有效|
|F5 刷新|有效|无效|
|Ctrl + F5 强制刷新|无效|无效|
