---
title: 浏览器回流和重绘
tag: 
  - 回流
  - 重绘
---

<!-- markdownlint-disable MD010 -->

> 参考: [浏览器的回流与重绘 (Reflow & Repaint)
](https://juejin.im/post/5a9923e9518825558251c96a?utm_medium=fe&utm_source=weixinqun)

## 基础

> **回流必引起重绘，重绘不一定会引起回流**

- 浏览器使用流式布局模型
- **浏览器会把 html 解析成 DOM，把 css 解析成 CSSOM, DOM 和 CSSOM 合并产生 render tree**
- 有了 render tree 就**知道所有节点的样式，然后计算他们在页面的大小和位置，最后把节点绘制在页面上**
- 由于浏览器使用流式布局，**对 render tree 的计算通常只需要遍历一次就可以完成，但是 table 和其内部元素除外，他们可能需要多次计算，通常要花 3 倍于同等元素的时间，这是为什么要避免使用 table 布局的原因之一**

<!-- more -->

## 回流

> **当 render tree 中部分或全部元素的尺寸、结构或某些属性发生改变时，浏览器重新渲染部分或全部文档的过程称为回流**

会引起回流的操作：

- 页面首次渲染
- 浏览器窗口大小发生改变
- 元素尺寸或位置发生改变
- 元素内容变化（文字数量或图片大小等）
- 元素字体变化
- 添加或删除**可见**的 dom 元素
- 激活 css 伪类
- 查询某些属性或调用某些方法

一些常用并且会导致会回流的属性和方法：

- clientWidth clientHeight clientTop clientLeft
- offsetWidth offsetHeight offsetTop offsetLeft
- scrollWidth scrollHeight scrollTop scrollLeft
- scrollIntoView() scrollIntoViewIfNeeded()
- getComputedStyle()
- getBoundingClientRect()
- scrollTo()

## 重绘

> **元素样式的改变并不影响它在文档流中的位置**（如 color、 background-color、 visibility 等),**浏览器会将新样式赋予元素并重新绘制的过程称为重绘**

## 性能影响

**回流比重绘的代价要高**

有时即使回流一个单一的元素，它的父元素和任何跟随它的元素也会产生回流

现代浏览器会对频繁的回流或重绘操作进行优化：

**浏览器会维护一个队列，把所有引起回流和重绘的操作放入队列，如果队列中的任务数量或时间间隔达到一个阈值，浏览器会将队列清空，进行一次批处理，这样可以多次回流和重绘变成一次**

当访问如下属性或方法时，浏览器会立刻清空队列：

- clientWidth clientHeight clientTop clientLeft
- offsetWidth offsetHeight offsetTop offsetLeft
- scrollWidth scrollHeight scrollTop scrollLeft
- width height
- getComputedStyle()
- getBoundingClientRect()

因为队列中可能会有影响到这些属性或方法返回值的操作，即使获取的信息和队列中的操作引发的改变无关，浏览器也会强行清空队列，确保拿到的值是最精确的

## 如何避免

### css

- 避免使用 table 布局
- 尽可能在 dom 树的最末端改变 class
- 避免设置多层内联样式
- 将动画效果应用到 position 属性为 absolute 或 fixed 元素上（已经不在文档流中）
- 避免使用 css 表达式（如 calc()）

### js

- **避免频繁操作样式**，最好一次性重写 style 属性，或者将样式列表定义为 class 并一次性更改 class 属性
- **避免频繁操作 dom，创建一个 documentFragment，在它上面应用所有的 dom 操作，最后再将它添加到文档中**
- 也可先将元素设置 display: none，操作结束后再把它显示出来，**因为 display 属性为 none 的元素上进行的 dom 操作不会引发回流和重绘**
- 避免频繁读取会引发回流重绘的属性，如果需要多次使用，就用一个**变量缓存起来**
- **对具有复杂动画的元素使用绝对定位，使他脱离文档流**，否则会引起父元素和侯素元素频发回流