---
title: 前端路由
tag: 
	- 前端路由
---

> 参考: [面试官系列(3): 前端路由的实现](https://juejin.im/post/5ac61da66fb9a028c71eae1b)

**路由的作用就是根据不同的路径映射到不同的视图。前端路由两种模式，`hash` 模式和 `history` 模式**，目前前端框架对前端路由的实现无非就是对这些前端模式进行相应的封装

## hash 路由

hash 路由带有 `#`，不够美观，但是浏览器兼容性较好。并且 **hash 变化的 url 都会被记录为浏览器历史记录，并且可以被浏览器前进后退访问**

- url hash 变化会**触发 `hashchange` 事件**
- 将路由 hash 和对应 cb 函数存储
- **监听 url 中 hash 变化，执行对应 cb 函数来进行路由跳转**

<!-- more -->

### hash 路由简易实现

```js
// 监听 url 中 hash 变化进行路由跳转 #/xxx
// hash 兼容性好，但是不美观

class Router {
  constructor() {
    // 以键值对形式存储路由
    this.routes = {}
    // 当前路由
    this.currentUrl = ''
    window.addEventListener('load', this.refresh.bind(this), false)
    window.addEventListener('hashchange', this.refresh.bind(this), false)
  }
  // 将 path 和对应 cb 存储
  route(path, cb) {
    this.routes[path] = cb || function() {}
  }
  refresh() {
    this.currentUrl = location.hash.slice(1) || '/'
    // 执行当前 hash 对应的回调
    this.routes[this.currentUrl]()
  }
}
```

```html
<body>
  <ul>
    <li><a href="#/red">turn red</a></li>
    <li><a href="#/yellow">turn yellow</a></li>
    <li><a href="#/">turn gray</a></li>
  </ul>
</body>
<script>
window.router = new Router()
function changeColor(color) {
  document.querySelector('body').style.backgroundColor = color
}
router.route('/', function() {
  changeColor('gray')
})
router.route('/yellow', function() {
  changeColor('yellow')
})
router.route('/red', function() {
  changeColor('red')
})
</script>
```

## html5 history 模式

html5 history api 可以分为两类， 切换和修改

### 切换历史状态

`back` `forward` `go` 三种方法对应浏览器的前进、后退和跳转

```js
history.back() // 后退
history.forward() // 前进
history.go(2) // 前进两次
history.go(-2) // 后退两次
```

### 修改历史状态

**每当同一个文档的浏览历史 （history 对象）发生变化，会触发 `popstate` 事件**

- `replaceState` 是**修改浏览历史中的当前记录，而不是添加记录，不触发跳转**，参数和 `pushState` 一样
- `pushState` 方法用于**在浏览器历史记录中添加记录，但是不会触发跳转**，接受三个参数：

> `state` 一个和指定网址相关的状态对象，`popstate` 事件触发时，该对象会传入回调函数，如果不需要，可设为 null 
> `title` 新页面的标题，但是所有浏览器目前都会忽略，可设为 null
> `url` 新的网址，必须和当前页面在同一个域。浏览器的地址栏将显示该网址

注意：仅仅调用 `popState` 和 `replaceState` 方法不会触发 `popstate` 事件，不是同一个文档也不会触发，**只有点击浏览器前进后退，或者 js 调用 `back` `forward` `go` 方法才会触发 `popstate` 事件**

### history 路由简易实现

```js
class Router {
  constructor() {
    this.routes = {}
    // 初始化监听 popstate 事件
    this._bindPopState()
  }
  // 初始化
  init(path) {
    // history.replaceState(null, null, path)
    history.replaceState({path: path}, null, path)
    this.routes[path] && this.routes[path]()
  }
  route(path, cb) {
    this.routes[path] = cb || function() {}
  }
  go(path) {
    // history.pushState(null, null, path)
    history.pushState({path: path}, null, path)
    this.routes[path] && this.routes[path]()
  }
  _bindPopState() {
    window.addEventListener('popstate', (e) => {
      const path = e.state && e.state.path
      this.routes[path] && this.routes[path]()
    })
  }
}
```

```html
<body>
  <ul>
    <li><a href="/red">turn red</a></li>
    <li><a href="/yellow">turn yellow</a></li>
    <li><a href="/">turn gray</a></li>
  </ul>
</body>
<script>
window.router = new Router()
router.init(location.pathname)
function changeColor(color) {
  document.querySelector('body').style.backgroundColor = color
}
router.route('/', function() {
  changeColor('gray')
})
router.route('/yellow', function() {
  changeColor('yellow')
})
router.route('/red', function() {
  changeColor('red')
})
document.querySelector('ul').addEventListener('click', function(e) {
  if (e.target.tagName === 'A') {
    e.preventDefault()
    router.go(e.target.getAttribute('href'))
  }
}, false)
</script>
```

### history 模式缺陷

history 模式下刷新会向服务器发起请求，如果后台没有进行配置，会报 404

hash 模式下前端路由修改的是 # 中的信息，不会发送请求，但是在 history 模式下，可以自由修改 path，刷新时如果服务器没有响应的响应或资源，会报 404

**解决方案是在后端增加一个覆盖所有情况的候选资源：当 url 匹配不到任何静态资源，应该返回同一个 `index.html`, 也就是你 app 依赖的页面**

- 原生 Node.js

```js
const http = require('http')
const fs = require('fs')
const httpPort = 80

// 每个请求都会调用 中间件
http.createServer((req, res) => {
  fs.readFile('index.htm', 'utf-8', (err, content) => {
    if (err) {
      console.log('We cannot open "index.htm" file.')
    }

    res.writeHead(200, {
      'Content-Type': 'text/html; charset=utf-8'
    })

    res.end(content)
  })
}).listen(httpPort, () => {
  console.log('Server listening on: http://localhost:%s', httpPort)
})
```

- 基于 Node.js 的 Express

对于 Node.js/Express，考虑使用 connect-history-api-fallback 中间件